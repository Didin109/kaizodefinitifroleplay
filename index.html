<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toko Senjata IC SAMP Definitive Roleplay</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #1a202c; /* Default background */
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #333;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-700 min-h-screen flex flex-col">
    <main id="app-container" class="flex-grow">
        <!-- Content will be rendered here by JavaScript -->
    </main>

    <!-- Footer Section -->
    <footer class="bg-gray-900 text-gray-400 py-6 text-center">
        <p>&copy; 2025 Toko Senjata IC SAMP. Hak Cipta Dilindungi.</p>
        <div class="mt-2">
            <a
                href="https://discord.gg/your-discord-link" <!-- GANTI DENGAN LINK DISCORD SERVER ANDA -->
                target="_blank"
                rel="noopener noreferrer"
                class="text-blue-400 hover:text-blue-300 transition duration-300"
            >
                Gabung Discord Definitive Roleplay
            </a>
        </div>
    </footer>

    <!-- Modal for Info Messages -->
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 max-w-sm w-full text-center">
            <p id="modal-content" class="text-white text-lg mb-6"></p>
            <button id="modal-ok-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                Oke
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, query, orderBy, addDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and user data
        let app;
        let db;
        let auth;
        let userId = null;
        let isAdmin = false;
        let isGeneratingDescription = false; // State for LLM loading

        // Replace with your actual admin UID.
        // You can get this from Firebase Console -> Authentication -> Users after logging in as admin.
        const ADMIN_UID = '1eaKUy41VMQJJqVNtknHvTNYMQr2'; // <<< GANTI DENGAN UID ADMIN ANDA YANG SEBENARNYA

        // Firebase Configuration (for deployment outside Canvas environment)
        // If running in Canvas, __firebase_config and __initial_auth_token are provided globally.
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyC4YNnmBQE2nkD0fCQ_LEI_WAwK51ItebY",
                authDomain: "server-f20df.firebaseapp.com",
                projectId: "server-f20df",
                storageBucket: "server-f20df.firebasestorage.app",
                messagingSenderId: "1042741872334",
                appId: "1:1042741872334:web:6c698e164bd6758ed9329f",
                measurementId: "G-JFN5SET77S"
            };

        // Initialize Firebase
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .then(() => {
                            console.log("Signed in with custom token.");
                        })
                        .catch((error) => {
                            console.error("Error signing in with custom token:", error);
                            signInAnonymously(auth)
                                .then(() => console.log("Signed in anonymously."))
                                .catch((anonError) => console.error("Error signing in anonymously:", anonError));
                        });
                } else {
                    signInAnonymously(auth)
                        .then(() => console.log("Signed in anonymously."))
                        .catch((error) => console.error("Error signing in anonymously:", error));
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        userId = crypto.randomUUID(); // Use a random ID if not authenticated
                    }
                    isAdmin = (userId === ADMIN_UID);
                    console.log("Firebase initialized. User ID:", userId, "Is Admin:", isAdmin);
                    // After auth state is ready, fetch data and render page
                    fetchWeapons();
                    renderPage('landing');
                });

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                showInfoModal("Gagal menginisialisasi Firebase. Silakan coba lagi.");
            }
        }

        // --- UI Rendering Functions ---
        const appContainer = document.getElementById('app-container');
        const infoModal = document.getElementById('info-modal');
        const modalContent = document.getElementById('modal-content');
        const modalOkButton = document.getElementById('modal-ok-button');

        modalOkButton.addEventListener('click', () => {
            infoModal.classList.add('hidden');
        });

        function showInfoModal(message) {
            modalContent.textContent = message;
            infoModal.classList.remove('hidden');
        }

        let weapons = [];
        let selectedWeapon = null;
        let chatMessages = [];
        let activeChatTicketId = null;

        function renderPage(pageName) {
            appContainer.innerHTML = ''; // Clear current content
            let pageContent = '';

            switch (pageName) {
                case 'landing':
                    pageContent = `
                        <div class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white p-4">
                            <h1 class="text-5xl font-extrabold mb-6 text-yellow-400 drop-shadow-lg">
                                Toko Senjata IC SAMP Definitive Roleplay
                            </h1>
                            <p class="text-xl text-gray-300 mb-8 text-center max-w-2xl">
                                Selamat datang di toko senjata pribadi saya untuk Definitive Roleplay. Di sini Anda bisa menemukan berbagai senjata IC untuk kebutuhan Anda.
                            </p>
                            <div class="space-x-4">
                                <button id="view-store-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-opacity-75">
                                    Lihat Toko
                                </button>
                                <button id="view-profile-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                                    Profil GTA Saya
                                </button>
                            </div>
                        </div>
                    `;
                    appContainer.innerHTML = pageContent;
                    document.getElementById('view-store-btn').addEventListener('click', () => renderPage('store'));
                    document.getElementById('view-profile-btn').addEventListener('click', () => renderPage('profile'));
                    break;

                case 'profile':
                    pageContent = `
                        <div class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white p-8 flex flex-col items-center">
                            <h2 class="text-4xl font-extrabold mb-8 text-yellow-400">Profil GTA Saya</h2>
                            <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full border border-gray-700">
                                <p class="text-lg mb-4"><strong class="text-yellow-300">Nama Karakter:</strong> [Nama Karakter Anda]</p>
                                <p class="text-lg mb-4"><strong class="text-yellow-300">Level:</strong> [Level Anda]</p>
                                <p class="text-lg mb-4"><strong class="text-yellow-300">Organisasi/Faksi:</strong> [Organisasi/Faksi Anda]</p>
                                <p class="text-lg mb-4"><strong class="text-yellow-300">UID Pengguna Web:</strong> ${userId}</p>
                                <p class="text-lg mb-4 text-gray-400 italic">
                                    Ini adalah profil IC pribadi saya. Informasi lebih lanjut akan ditambahkan di sini.
                                </p>
                            </div>
                            <button id="back-to-landing-btn" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                                Kembali ke Beranda
                            </button>
                        </div>
                    `;
                    appContainer.innerHTML = pageContent;
                    document.getElementById('back-to-landing-btn').addEventListener('click', () => renderPage('landing'));
                    break;

                case 'store':
                    pageContent = `
                        <div class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white p-8">
                            <h2 class="text-4xl font-extrabold mb-8 text-yellow-400 text-center">Toko Senjata IC</h2>
                            <div id="weapons-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-5xl mx-auto">
                                <!-- Weapons will be loaded here -->
                            </div>
                            <button id="back-to-landing-btn" class="mt-12 mx-auto block bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                                Kembali ke Beranda
                            </button>
                        </div>
                    `;
                    appContainer.innerHTML = pageContent;
                    document.getElementById('back-to-landing-btn').addEventListener('click', () => renderPage('landing'));
                    renderWeapons(); // Call function to render weapons after page structure is in place
                    break;

                case 'chat':
                    pageContent = `
                        <div class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white p-8 flex flex-col">
                            <h2 class="text-4xl font-extrabold mb-6 text-yellow-400 text-center">Chat Transaksi</h2>
                            <p class="text-xl text-gray-300 mb-4 text-center">Transaksi untuk: <span class="font-bold text-yellow-300">${selectedWeapon ? selectedWeapon.name : 'N/A'}</span></p>
                            <div class="flex-grow bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 flex flex-col overflow-hidden">
                                <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 p-2 custom-scrollbar">
                                    <!-- Chat messages will be loaded here -->
                                </div>
                                <div class="flex mt-4">
                                    <input type="text" id="new-message-input" placeholder="Ketik pesan Anda..." class="flex-grow p-3 rounded-l-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    <button id="send-message-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-r-lg shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                                        Kirim
                                    </button>
                                </div>
                                ${isAdmin ? `
                                    <button id="complete-transaction-btn" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                                        Selesaikan Transaksi
                                    </button>
                                ` : ''}
                            </div>
                            <button id="back-to-store-btn" class="mt-8 mx-auto block bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                                Kembali ke Toko
                            </button>
                        </div>
                    `;
                    appContainer.innerHTML = pageContent;
                    document.getElementById('send-message-btn').addEventListener('click', handleSendMessage);
                    document.getElementById('back-to-store-btn').addEventListener('click', () => {
                        renderPage('store');
                        activeChatTicketId = null;
                        chatMessages = [];
                    });
                    if (isAdmin) {
                        document.getElementById('complete-transaction-btn').addEventListener('click', handleCompleteTransaction);
                    }
                    fetchChatMessages(); // Fetch messages for the active chat
                    break;
            }
        }

        function renderWeapons() {
            const weaponsGrid = document.getElementById('weapons-grid');
            weaponsGrid.innerHTML = ''; // Clear existing weapons

            if (weapons.length === 0) {
                weaponsGrid.innerHTML = '<p class="col-span-full text-center text-gray-400">Tidak ada senjata yang tersedia saat ini.</p>';
                return;
            }

            weapons.forEach(weapon => {
                const weaponCard = document.createElement('div');
                weaponCard.className = 'bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 flex flex-col';
                weaponCard.innerHTML = `
                    <h3 class="text-2xl font-bold text-yellow-300 mb-2">${weapon.name}</h3>
                    <p class="text-gray-300 mb-4 flex-grow">${weapon.description || 'Deskripsi belum tersedia.'}</p>
                    <p class="text-xl font-semibold text-green-400 mb-4">Harga: $${weapon.priceIC} IC</p>
                    <div class="flex items-center justify-between">
                        <p class="text-lg">Stok: <span class="font-bold">${weapon.stock}</span></p>
                        ${isAdmin ? `
                            <div class="flex items-center space-x-2">
                                <button data-weapon-id="${weapon.id}" data-action="decrease-stock" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-sm ${weapon.stock <= 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${weapon.stock <= 0 ? 'disabled' : ''}>-</button>
                                <input type="number" value="${weapon.stock}" data-weapon-id="${weapon.id}" data-action="set-stock" class="w-16 bg-gray-700 text-white rounded-md text-center" min="0" />
                                <button data-weapon-id="${weapon.id}" data-action="increase-stock" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-full text-sm">+</button>
                            </div>
                        ` : ''}
                    </div>
                    ${isAdmin ? `
                        <button data-weapon-id="${weapon.id}" data-weapon-name="${weapon.name}" data-action="generate-description" class="mt-4 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition duration-300 ${isGeneratingDescription ? 'opacity-50 cursor-not-allowed' : ''}" ${isGeneratingDescription ? 'disabled' : ''}>
                            ${isGeneratingDescription ? 'Menghasilkan...' : '✨ Generate Deskripsi'}
                        </button>
                    ` : ''}
                    <button data-weapon-id="${weapon.id}" data-action="buy-weapon" class="mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 hover:scale-105 ${weapon.stock <= 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${weapon.stock <= 0 ? 'disabled' : ''}>
                        Beli Sekarang
                    </button>
                `;
                weaponsGrid.appendChild(weaponCard);
            });

            // Add event listeners for dynamically created buttons
            weaponsGrid.querySelectorAll('[data-action="buy-weapon"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const weaponId = e.target.dataset.weaponId;
                    const weapon = weapons.find(w => w.id === weaponId);
                    if (weapon) handleBuyWeapon(weapon);
                });
            });

            if (isAdmin) {
                weaponsGrid.querySelectorAll('[data-action="decrease-stock"]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const weaponId = e.target.dataset.weaponId;
                        const weapon = weapons.find(w => w.id === weaponId);
                        if (weapon) handleUpdateStock(weapon.id, weapon.stock - 1);
                    });
                });
                weaponsGrid.querySelectorAll('[data-action="increase-stock"]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const weaponId = e.target.dataset.weaponId;
                        const weapon = weapons.find(w => w.id === weaponId);
                        if (weapon) handleUpdateStock(weapon.id, weapon.stock + 1);
                    });
                });
                weaponsGrid.querySelectorAll('[data-action="set-stock"]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const weaponId = e.target.dataset.weaponId;
                        const newStock = parseInt(e.target.value);
                        if (!isNaN(newStock)) {
                            handleUpdateStock(weaponId, newStock);
                        }
                    });
                });
                weaponsGrid.querySelectorAll('[data-action="generate-description"]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const weaponId = e.target.dataset.weaponId;
                        const weaponName = e.target.dataset.weaponName;
                        handleGenerateWeaponDescription(weaponId, weaponName);
                    });
                });
            }
        }

        function renderChatMessages() {
            const chatMessagesContainer = document.getElementById('chat-messages');
            if (!chatMessagesContainer) return; // Exit if chat container not found

            chatMessagesContainer.innerHTML = ''; // Clear existing messages

            if (chatMessages.length === 0) {
                chatMessagesContainer.innerHTML = '<p class="text-gray-400 text-center">Mulai chat untuk transaksi Anda.</p>';
                return;
            }

            chatMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `mb-3 p-3 rounded-lg max-w-[70%] ${msg.senderId === userId ? 'bg-blue-700 ml-auto' : 'bg-gray-700 mr-auto'}`;
                messageDiv.innerHTML = `
                    <p class="font-bold text-sm text-gray-300">${msg.senderName}</p>
                    <p class="text-lg">${msg.message}</p>
                    <p class="text-xs text-right text-gray-400 mt-1">
                        ${new Date(msg.timestamp).toLocaleString()}
                    </p>
                `;
                chatMessagesContainer.appendChild(messageDiv);
            });
            // Scroll to the bottom of the chat
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        // --- Firebase Data Handling Functions ---
        function fetchWeapons() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const weaponsColRef = collection(db, `artifacts/${appId}/public/data/weapons`);
            const q = query(weaponsColRef);

            onSnapshot(q, (snapshot) => {
                weapons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('weapons-grid')) { // Only re-render if on store page
                    renderWeapons();
                }
            }, (error) => {
                console.error("Error fetching weapons:", error);
                showInfoModal("Gagal memuat data senjata. Silakan coba lagi.");
            });
        }

        function fetchChatMessages() {
            if (!db || !activeChatTicketId || !userId) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const chatMessagesColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions/${activeChatTicketId}/messages`);
            const q = query(chatMessagesColRef, orderBy('timestamp'));

            onSnapshot(q, (snapshot) => {
                chatMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('chat-messages')) { // Only re-render if on chat page
                    renderChatMessages();
                }
            }, (error) => {
                console.error("Error fetching chat messages:", error);
                showInfoModal("Gagal memuat pesan chat. Silakan coba lagi.");
            });
        }

        async function handleBuyWeapon(weapon) {
            if (!db || !userId) {
                showInfoModal("Firebase belum siap atau pengguna tidak terautentikasi.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userTransactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);

                const q = query(userTransactionsColRef);
                const existingTicketsSnapshot = await getDocs(q);
                let existingTicket = null;

                existingTicketsSnapshot.forEach(doc => {
                    if (doc.data().weaponId === weapon.id && doc.data().status === 'open') {
                        existingTicket = { id: doc.id, ...doc.data() };
                    }
                });

                if (existingTicket) {
                    activeChatTicketId = existingTicket.id;
                    showInfoModal(`Anda sudah memiliki tiket transaksi terbuka untuk ${weapon.name}. Melanjutkan chat yang sudah ada.`);
                } else {
                    const newTicketRef = await addDoc(userTransactionsColRef, {
                        weaponId: weapon.id,
                        weaponName: weapon.name,
                        buyerId: userId,
                        status: 'open',
                        createdAt: new Date().toISOString(),
                    });
                    activeChatTicketId = newTicketRef.id;
                    showInfoModal(`Tiket transaksi baru untuk ${weapon.name} telah dibuat. Silakan mulai chat.`);
                }

                selectedWeapon = weapon;
                renderPage('chat');
            } catch (error) {
                console.error("Error creating/accessing transaction ticket:", error);
                showInfoModal("Gagal memulai transaksi. Silakan coba lagi.");
            }
        }

        async function handleSendMessage() {
            const newMessageInput = document.getElementById('new-message-input');
            const messageText = newMessageInput ? newMessageInput.value.trim() : '';

            if (!db || !userId || !activeChatTicketId || messageText === '') {
                showInfoModal("Pesan tidak boleh kosong atau chat belum siap.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const messagesColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions/${activeChatTicketId}/messages`);

                await addDoc(messagesColRef, {
                    senderId: userId,
                    senderName: userId === ADMIN_UID ? 'Admin' : 'Pembeli',
                    message: messageText,
                    timestamp: Date.now(),
                });
                if (newMessageInput) newMessageInput.value = ''; // Clear input
            } catch (error) {
                console.error("Error sending message:", error);
                showInfoModal("Gagal mengirim pesan. Silakan coba lagi.");
            }
        }

        async function handleCompleteTransaction() {
            if (!db || !userId || !activeChatTicketId || !isAdmin) {
                showInfoModal("Anda tidak memiliki izin untuk menyelesaikan transaksi ini.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const transactionDocRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, activeChatTicketId);

                await updateDoc(transactionDocRef, {
                    status: 'completed',
                    completedAt: new Date().toISOString(),
                });

                showInfoModal("Transaksi berhasil diselesaikan!");
                activeChatTicketId = null;
                chatMessages = [];
                renderPage('store');
            } catch (error) {
                console.error("Error completing transaction:", error);
                showInfoModal("Gagal menyelesaikan transaksi. Silakan coba lagi.");
            }
        }

        async function handleUpdateStock(weaponId, newStock) {
            if (!db || !isAdmin) {
                showInfoModal("Anda tidak memiliki izin untuk mengubah stok.");
                return;
            }
            if (newStock < 0) {
                showInfoModal("Stok tidak bisa kurang dari 0.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const weaponDocRef = doc(db, `artifacts/${appId}/public/data/weapons`, weaponId);
                await updateDoc(weaponDocRef, { stock: newStock });
                showInfoModal("Stok berhasil diperbarui!");
            } catch (error) {
                console.error("Error updating stock:", error);
                showInfoModal("Gagal memperbarui stok. Silakan coba lagi.");
            }
        }

        async function handleGenerateWeaponDescription(weaponId, weaponName) {
            if (!db || !isAdmin) {
                showInfoModal("Anda tidak memiliki izin untuk menghasilkan deskripsi.");
                return;
            }

            isGeneratingDescription = true;
            // Re-render weapons to show loading state on the button
            if (document.getElementById('weapons-grid')) {
                renderWeapons();
            }
            showInfoModal("Menghasilkan deskripsi senjata... Mohon tunggu.");

            try {
                const prompt = `Buatkan deskripsi roleplay singkat dan menarik (maksimal 3 kalimat) untuk senjata SAMP Definitive Roleplay bernama ${weaponName}. Fokus pada kegunaan IC (in-character) dan nuansa roleplay.`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;

                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const weaponDocRef = doc(db, `artifacts/${appId}/public/data/weapons`, weaponId);
                    await updateDoc(weaponDocRef, { description: generatedText });

                    showInfoModal(`Deskripsi untuk ${weaponName} berhasil diperbarui!`);
                } else {
                    showInfoModal("Gagal menghasilkan deskripsi. Respon LLM tidak valid.");
                }
            } catch (error) {
                console.error("Error generating weapon description:", error);
                showInfoModal("Terjadi kesalahan saat menghasilkan deskripsi. Silakan coba lagi.");
            } finally {
                isGeneratingDescription = false;
                // Re-render weapons to remove loading state
                if (document.getElementById('weapons-grid')) {
                    renderWeapons();
                }
            }
        }

        // Initialize Firebase and render the landing page when the window loads
        window.onload = initializeFirebase;
    </script>
</body>
</html>
