<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toko Senjata IC SAMP Definitive Roleplay</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #1a202c; /* Default background */
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #333;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-700 min-h-screen flex flex-col">
    <main id="app-container" class="flex-grow">
        <!-- Konten akan dirender di sini oleh JavaScript -->
    </main>

    <!-- Bagian Footer -->
    <footer class="bg-gray-900 text-gray-400 py-6 text-center w-full">
        <p class="mb-2">&copy; 2025 Toko Senjata IC SAMP. Hak Cipta Dilindungi.</p>
        <div class="mt-2">
            <!-- PENTING: GANTI LINK DISCORD INI DENGAN LINK SERVER DISCORD ANDA YANG SEBENARNYA -->
            <a
                href="https://discord.gg/your-discord-link"
                target="_blank"
                rel="noopener noreferrer"
                class="text-blue-400 hover:text-blue-300 transition duration-300 text-lg font-semibold"
            >
                Gabung Discord Definitive Roleplay
            </a>
        </div>
        <div class="mt-4">
            <button id="admin-login-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                Admin Login
            </button>
            <button id="admin-logout-btn" class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 hidden">
                Admin Logout
            </button>
        </div>
    </footer>

    <!-- Modal untuk Pesan Informasi -->
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 max-w-sm w-full text-center">
            <p id="modal-content" class="text-white text-lg mb-6"></p>
            <button id="modal-ok-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                Oke
            </button>
        </div>
    </div>

    <!-- Modal untuk Login Admin -->
    <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold text-yellow-300 mb-6">Login Admin</h3>
            <input type="email" id="admin-email" placeholder="Email Admin" class="w-full p-3 mb-4 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <input type="password" id="admin-password" placeholder="Password Admin" class="w-full p-3 mb-6 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <button id="perform-admin-login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                Login
            </button>
            <button id="close-admin-login-modal-btn" class="ml-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                Batal
            </button>
        </div>
    </div>

    <!-- Modal untuk Tambah Senjata Baru (New Admin Feature) -->
    <div id="add-weapon-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold text-yellow-300 mb-6">Tambah Senjata Baru</h3>
            <input type="text" id="new-weapon-name" placeholder="Nama Senjata" class="w-full p-3 mb-4 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <textarea id="new-weapon-description" placeholder="Deskripsi Senjata" class="w-full p-3 mb-4 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 h-24"></textarea>
            <input type="number" id="new-weapon-price" placeholder="Harga IC" class="w-full p-3 mb-4 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" />
            <input type="number" id="new-weapon-stock" placeholder="Stok" class="w-full p-3 mb-6 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" />
            <button id="perform-add-weapon-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                Tambah Senjata
            </button>
            <button id="close-add-weapon-modal-btn" class="ml-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                Batal
            </button>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, query, orderBy, addDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabel global untuk instance Firebase dan data pengguna
        let app;
        let db;
        let auth;
        let userId = null;
        let isAdmin = false;
        let isGeneratingDescription = false; // Status untuk loading LLM

        // UID Admin Anda (GANTI DENGAN UID AKUN EMAIL/PASSWORD ADMIN YANG ANDA BUAT DI FIREBASE)
        const ADMIN_UID = 'Y8PfnW65zGbTdSn0UBDBc825pMu2'; // <<< UID ADMIN ANDA

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
          apiKey: "AIzaSyDt9JHvJpLKnU3zI1uqOq3scOLIeiQSnl4",
          authDomain: "minecraftweb-8fc71.firebaseapp.com",
          projectId: "minecraftweb-8fc71",
          storageBucket: "minecraftweb-8fc71.firebasestorage.app",
          messagingSenderId: "190426156767",
          appId: "1:190426156767:web:bce92703bc2632dca1e36a",
          measurementId: "G-ZGKJT18EY1"
        };


        // Inisialisasi Firebase
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .then(() => {
                            console.log("Signed in with custom token.");
                        })
                        .catch((error) => {
                            console.error("Error signing in with custom token:", error);
                            signInAnonymously(auth)
                                .then(() => console.log("Signed in anonymously."))
                                .catch((anonError) => console.error("Error signing in anonymously:", anonError));
                        });
                } else {
                    signInAnonymously(auth)
                        .then(() => console.log("Signed in anonymously."))
                        .catch((error) => console.error("Error signing in anonymously:", error));
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        userId = crypto.randomUUID();
                    }
                    isAdmin = (userId === ADMIN_UID);
                    console.log("Firebase initialized. User ID:", userId, "Is Admin:", isAdmin);
                    updateAdminButtonsVisibility();
                    fetchWeapons();
                    renderPage('landing');
                });

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                showInfoModal("Gagal menginisialisasi Firebase. Silakan coba lagi.");
            }
        }

        // --- Fungsi UI Umum ---
        const appContainer = document.getElementById('app-container');
        const infoModal = document.getElementById('info-modal');
        const modalContent = document.getElementById('modal-content');
        const modalOkButton = document.getElementById('modal-ok-button');
        const adminLoginModal = document.getElementById('admin-login-modal');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const performAdminLoginBtn = document.getElementById('perform-admin-login-btn');
        const closeAdminLoginModalBtn = document.getElementById('close-admin-login-modal-btn');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');

        // Elemen-elemen baru untuk modal tambah senjata
        const addWeaponModal = document.getElementById('add-weapon-modal');
        const newWeaponNameInput = document.getElementById('new-weapon-name');
        const newWeaponDescriptionInput = document.getElementById('new-weapon-description');
        const newWeaponPriceInput = document.getElementById('new-weapon-price');
        const newWeaponStockInput = document.getElementById('new-weapon-stock');
        const performAddWeaponBtn = document.getElementById('perform-add-weapon-btn');
        const closeAddWeaponModalBtn = document.getElementById('close-add-weapon-modal-btn');


        modalOkButton.addEventListener('click', () => {
            infoModal.classList.add('hidden');
        });

        function showInfoModal(message) {
            modalContent.textContent = message;
            infoModal.classList.remove('hidden');
        }

        // --- Admin Login/Logout Logic ---
        adminLoginBtn.addEventListener('click', () => {
            adminLoginModal.classList.remove('hidden');
        });

        closeAdminLoginModalBtn.addEventListener('click', () => {
            adminLoginModal.classList.add('hidden');
            adminEmailInput.value = '';
            adminPasswordInput.value = '';
        });

        performAdminLoginBtn.addEventListener('click', async () => {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;

            if (!email || !password) {
                showInfoModal("Email dan password tidak boleh kosong.");
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (userCredential.user.uid === ADMIN_UID) {
                    showInfoModal("Login admin berhasil!");
                    adminLoginModal.classList.add('hidden');
                    adminEmailInput.value = '';
                    adminPasswordInput.value = '';
                } else {
                    await signOut(auth);
                    showInfoModal("Akses ditolak. Ini bukan akun admin yang terdaftar.");
                }
            } catch (error) {
                console.error("Error during admin login:", error);
                showInfoModal(`Login gagal: ${error.message}`);
            }
        });

        adminLogoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showInfoModal("Logout admin berhasil!");
                renderPage('landing');
            } catch (error) {
                console.error("Error during admin logout:", error);
                showInfoModal(`Logout gagal: ${error.message}`);
            }
        });

        function updateAdminButtonsVisibility() {
            if (isAdmin) {
                adminLoginBtn.classList.add('hidden');
                adminLogoutBtn.classList.remove('hidden');
            } else {
                adminLoginBtn.classList.remove('hidden');
                adminLogoutBtn.classList.add('hidden');
            }
        }

        // --- Variabel State Aplikasi ---
        let weapons = [];
        let selectedWeapon = null;
        let chatMessages = [];
        let activeChatTicketId = null;
        let activeChatBuyerId = null; // New: To store the buyer's UID for admin chat view
        let adminChatTickets = []; // New: To store all incoming chat tickets for admin

        // --- Fungsi Rendering Halaman ---
        function renderPage(pageName) {
            appContainer.innerHTML = ''; // Hapus konten saat ini
            let pageContent = '';

            switch (pageName) {
                case 'landing':
                    pageContent = `
                        <div class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white p-4">
                            <h1 class="text-5xl font-extrabold mb-6 text-yellow-400 drop-shadow-lg">
                                Toko Senjata IC SAMP Definitive Roleplay
                            </h1>
                            <p class="text-xl text-gray-300 mb-8 text-center max-w-2xl">
                                Selamat datang di toko senjata pribadi saya untuk Definitive Roleplay. Di sini Anda bisa menemukan berbagai senjata IC untuk kebutuhan Anda.
                            </p>
                            <div class="space-x-4">
                                <button id="view-store-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-opacity-75">
                                    Lihat Toko
                                </button>
                                <button id="view-profile-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                                    Profil GTA Saya
                                </button>
                            </div>
                        </div>
                    `;
                    appContainer.innerHTML = pageContent;
                    document.getElementById('view-store-btn').addEventListener('click', () => renderPage('store'));
                    document.getElementById('view-profile-btn').addEventListener('click', () => renderPage('profile'));
                    break;

                case 'profile':
                    pageContent = `
                        <div class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white p-8 flex flex-col items-center">
                            <h2 class="text-4xl font-extrabold mb-8 text-yellow-400">Profil GTA Saya</h2>
                            <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full border border-gray-700">
                                <p class="text-lg mb-4"><strong class="text-yellow-300">Nama Karakter:</strong> [Nama Karakter Anda]</p>
                                <p class="text-lg mb-4"><strong class="text-yellow-300">Level:</strong> [Level Anda]</p>
                                <p class="text-lg mb-4"><strong class="text-yellow-300">Organisasi/Faksi:</strong> [Organisasi/Faksi Anda]</p>
                                <p class="text-lg mb-4"><strong class="text-yellow-300">UID Pengguna Web:</strong> ${userId}</p>
                                <p class="text-lg mb-4 text-gray-400 italic">
                                    Ini adalah profil IC pribadi saya. Informasi lebih lanjut akan ditambahkan di sini.
                                </p>
                            </div>
                            <button id="back-to-landing-btn" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                                Kembali ke Beranda
                            </button>
                        </div>
                    `;
                    appContainer.innerHTML = pageContent;
                    document.getElementById('back-to-landing-btn').addEventListener('click', () => renderPage('landing'));
                    break;

                case 'store':
                    pageContent = `
                        <div class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white p-8">
                            <h2 class="text-4xl font-extrabold mb-8 text-yellow-400 text-center">Toko Senjata IC</h2>
                            ${isAdmin ? `
                                <div class="text-center mb-8 space-x-4">
                                    <button id="add-new-weapon-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                                        + Tambah Senjata Baru
                                    </button>
                                    <button id="view-chat-tickets-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                                        Lihat Tiket Chat
                                    </button>
                                </div>
                            ` : ''}
                            <div id="weapons-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-5xl mx-auto">
                                <!-- Senjata akan dimuat di sini -->
                            </div>
                            <button id="back-to-landing-btn" class="mt-12 mx-auto block bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                                Kembali ke Beranda
                            </button>
                        </div>
                    `;
                    appContainer.innerHTML = pageContent;
                    document.getElementById('back-to-landing-btn').addEventListener('click', () => renderPage('landing'));
                    if (isAdmin) {
                        document.getElementById('add-new-weapon-btn').addEventListener('click', () => addWeaponModal.classList.remove('hidden'));
                        document.getElementById('view-chat-tickets-btn').addEventListener('click', () => renderPage('admin-tickets'));
                    }
                    renderWeapons(); // Panggil fungsi untuk merender senjata setelah struktur halaman ada
                    break;

                case 'chat':
                    pageContent = `
                        <div class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white p-8 flex flex-col">
                            <h2 class="text-4xl font-extrabold mb-6 text-yellow-400 text-center">Chat Transaksi</h2>
                            <p class="text-xl text-gray-300 mb-4 text-center">Transaksi untuk: <span class="font-bold text-yellow-300">${selectedWeapon ? selectedWeapon.name : 'N/A'}</span></p>
                            <div class="flex-grow bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 flex flex-col overflow-hidden">
                                <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 p-2 custom-scrollbar">
                                    <!-- Pesan chat akan dimuat di sini -->
                                </div>
                                <div class="flex mt-4">
                                    <input type="text" id="new-message-input" placeholder="Ketik pesan Anda..." class="flex-grow p-3 rounded-l-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    <button id="send-message-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-r-lg shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                                        Kirim
                                    </button>
                                </div>
                                ${isAdmin ? `
                                    <button id="complete-transaction-btn" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                                        Selesaikan Transaksi
                                    </button>
                                ` : ''}
                            </div>
                            <button id="back-to-store-btn" class="mt-8 mx-auto block bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                                Kembali ke Toko
                            </button>
                        </div>
                    `;
                    appContainer.innerHTML = pageContent;
                    document.getElementById('send-message-btn').addEventListener('click', handleSendMessage);
                    document.getElementById('back-to-store-btn').addEventListener('click', () => {
                        renderPage('store');
                        activeChatTicketId = null;
                        activeChatBuyerId = null; // Clear buyer ID
                        chatMessages = [];
                    });
                    if (isAdmin) {
                        document.getElementById('complete-transaction-btn').addEventListener('click', handleCompleteTransaction);
                    }
                    fetchChatMessages(); // Ambil pesan untuk chat aktif
                    break;

                case 'admin-tickets':
                    pageContent = `
                        <div class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white p-8">
                            <h2 class="text-4xl font-extrabold mb-8 text-yellow-400 text-center">Tiket Chat Masuk (Admin)</h2>
                            <div id="admin-tickets-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto">
                                <!-- Tiket chat akan dimuat di sini -->
                            </div>
                            <button id="back-to-store-from-tickets-btn" class="mt-12 mx-auto block bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                                Kembali ke Toko
                            </button>
                        </div>
                    `;
                    appContainer.innerHTML = pageContent;
                    document.getElementById('back-to-store-from-tickets-btn').addEventListener('click', () => renderPage('store'));
                    fetchAdminChatTickets(); // Fetch and render admin tickets
                    break;
            }
        }

        function renderWeapons() {
            const weaponsGrid = document.getElementById('weapons-grid');
            weaponsGrid.innerHTML = ''; // Hapus senjata yang ada

            if (weapons.length === 0) {
                weaponsGrid.innerHTML = '<p class="col-span-full text-center text-gray-400">Tidak ada senjata yang tersedia saat ini.</p>';
                return;
            }

            weapons.forEach(weapon => {
                const weaponCard = document.createElement('div');
                weaponCard.className = 'bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 flex flex-col';
                weaponCard.innerHTML = `
                    <h3 class="text-2xl font-bold text-yellow-300 mb-2">${weapon.name}</h3>
                    <p class="text-gray-300 mb-4 flex-grow">${weapon.description || 'Deskripsi belum tersedia.'}</p>
                    <p class="text-xl font-semibold text-green-400 mb-4">Harga: $${weapon.priceIC} IC</p>
                    <div class="flex items-center justify-between">
                        <p class="text-lg">Stok: <span class="font-bold">${weapon.stock}</span></p>
                        ${isAdmin ? `
                            <div class="flex items-center space-x-2">
                                <button data-weapon-id="${weapon.id}" data-action="decrease-stock" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-sm ${weapon.stock <= 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${weapon.stock <= 0 ? 'disabled' : ''}>-</button>
                                <input type="number" value="${weapon.stock}" data-weapon-id="${weapon.id}" data-action="set-stock" class="w-16 bg-gray-700 text-white rounded-md text-center" min="0" />
                                <button data-weapon-id="${weapon.id}" data-action="increase-stock" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-full text-sm">+</button>
                            </div>
                        ` : ''}
                    </div>
                    ${isAdmin ? `
                        <button data-weapon-id="${weapon.id}" data-weapon-name="${weapon.name}" data-action="generate-description" class="mt-4 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition duration-300 ${isGeneratingDescription ? 'opacity-50 cursor-not-allowed' : ''}" ${isGeneratingDescription ? 'disabled' : ''}>
                            ${isGeneratingDescription ? 'Menghasilkan...' : '✨ Generate Deskripsi'}
                        </button>
                    ` : ''}
                    <button data-weapon-id="${weapon.id}" data-action="buy-weapon" class="mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 hover:scale-105 ${weapon.stock <= 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${weapon.stock <= 0 ? 'disabled' : ''}>
                        Beli Sekarang
                    </button>
                `;
                weaponsGrid.appendChild(weaponCard);
            });

            // Tambahkan event listener untuk tombol yang dibuat secara dinamis
            weaponsGrid.querySelectorAll('[data-action="buy-weapon"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const weaponId = e.target.dataset.weaponId;
                    const weapon = weapons.find(w => w.id === weaponId);
                    if (weapon) handleBuyWeapon(weapon);
                });
            });

            if (isAdmin) {
                weaponsGrid.querySelectorAll('[data-action="decrease-stock"]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const weaponId = e.target.dataset.weaponId;
                        const weapon = weapons.find(w => w.id === weaponId);
                        if (weapon) handleUpdateStock(weapon.id, weapon.stock - 1);
                    });
                });
                weaponsGrid.querySelectorAll('[data-action="increase-stock"]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const weaponId = e.target.dataset.weaponId;
                        const weapon = weapons.find(w => w.id === weaponId);
                        if (weapon) handleUpdateStock(weapon.id, weapon.stock + 1);
                    });
                });
                weaponsGrid.querySelectorAll('[data-action="set-stock"]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const weaponId = e.target.dataset.weaponId;
                        const newStock = parseInt(e.target.value);
                        if (!isNaN(newStock)) {
                            handleUpdateStock(weaponId, newStock);
                        }
                    });
                });
                weaponsGrid.querySelectorAll('[data-action="generate-description"]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const weaponId = e.target.dataset.weaponId;
                        const weaponName = e.target.dataset.weaponName;
                        handleGenerateWeaponDescription(weaponId, weaponName);
                    });
                });
            }
        }

        function renderChatMessages() {
            const chatMessagesContainer = document.getElementById('chat-messages');
            if (!chatMessagesContainer) return; // Keluar jika kontainer chat tidak ditemukan

            chatMessagesContainer.innerHTML = ''; // Hapus pesan yang ada

            if (chatMessages.length === 0) {
                chatMessagesContainer.innerHTML = '<p class="text-gray-400 text-center">Mulai chat untuk transaksi Anda.</p>';
                return;
            }

            chatMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `mb-3 p-3 rounded-lg max-w-[70%] ${msg.senderId === userId ? 'bg-blue-700 ml-auto' : 'bg-gray-700 mr-auto'}`;
                messageDiv.innerHTML = `
                    <p class="font-bold text-sm text-gray-300">${msg.senderName}</p>
                    <p class="text-lg">${msg.message}</p>
                    <p class="text-xs text-right text-gray-400 mt-1">
                        ${new Date(msg.timestamp).toLocaleString()}
                    </p>
                `;
                chatMessagesContainer.appendChild(messageDiv);
            });
            // Gulir ke bagian bawah chat
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        // --- Fungsi Penanganan Data Firebase ---
        function fetchWeapons() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const weaponsColRef = collection(db, `artifacts/${appId}/public/data/weapons`);
            const q = query(weaponsColRef);

            onSnapshot(q, (snapshot) => {
                weapons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('weapons-grid')) { // Hanya render ulang jika di halaman toko
                    renderWeapons();
                }
            }, (error) => {
                console.error("Error fetching weapons:", error);
                showInfoModal("Gagal memuat data senjata. Silakan coba lagi.");
            });
        }

        function fetchChatMessages() {
            if (!db || !activeChatTicketId || !activeChatBuyerId) return; // Ensure buyer ID is available for admin view

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Use activeChatBuyerId for fetching messages for admin view
            const messagesColRef = collection(db, `artifacts/${appId}/users/${activeChatBuyerId}/transactions/${activeChatTicketId}/messages`);
            const q = query(messagesColRef, orderBy('timestamp'));

            onSnapshot(q, (snapshot) => {
                chatMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('chat-messages')) {
                    renderChatMessages();
                }
            }, (error) => {
                console.error("Error fetching chat messages:", error);
                showInfoModal("Gagal memuat pesan chat. Silakan coba lagi.");
            });
        }

        // New function to fetch all chat tickets for admin
        function fetchAdminChatTickets() {
            if (!db || !isAdmin) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const publicTransactionsColRef = collection(db, `artifacts/${appId}/public/data/transactions`);
            const q = query(publicTransactionsColRef, orderBy('createdAt', 'desc')); // Order by creation time

            onSnapshot(q, (snapshot) => {
                adminChatTickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminChatTickets(); // Render the tickets
            }, (error) => {
                console.error("Error fetching admin chat tickets:", error);
                showInfoModal("Gagal memuat tiket chat admin. Silakan coba lagi.");
            });
        }

        // New function to render admin chat tickets
        function renderAdminChatTickets() {
            const adminTicketsList = document.getElementById('admin-tickets-list');
            if (!adminTicketsList) return;

            adminTicketsList.innerHTML = ''; // Clear existing list

            if (adminChatTickets.length === 0) {
                adminTicketsList.innerHTML = '<p class="col-span-full text-center text-gray-400">Tidak ada tiket chat yang masuk.</p>';
                return;
            }

            adminChatTickets.forEach(ticket => {
                const ticketCard = document.createElement('div');
                ticketCard.className = `bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 flex flex-col cursor-pointer hover:bg-gray-700 transition duration-200 ${ticket.status === 'completed' ? 'opacity-70 border-green-500' : 'border-red-500'}`;
                ticketCard.dataset.ticketId = ticket.id;
                ticketCard.dataset.buyerId = ticket.buyerId; // Store buyer ID for chat navigation
                ticketCard.innerHTML = `
                    <h3 class="text-xl font-bold text-yellow-300 mb-2">Senjata: ${ticket.weaponName}</h3>
                    <p class="text-gray-300 mb-1">Pembeli UID: ${ticket.buyerId}</p>
                    <p class="text-gray-300 mb-1">Status: <span class="font-semibold ${ticket.status === 'completed' ? 'text-green-400' : 'text-red-400'}">${ticket.status.toUpperCase()}</span></p>
                    <p class="text-sm text-gray-400 mt-2">Dibuat: ${new Date(ticket.createdAt).toLocaleString()}</p>
                `;
                adminTicketsList.appendChild(ticketCard);

                ticketCard.addEventListener('click', (e) => {
                    const clickedTicketId = e.currentTarget.dataset.ticketId;
                    const clickedBuyerId = e.currentTarget.dataset.buyerId;
                    // Set global variables for chat page
                    activeChatTicketId = clickedTicketId;
                    activeChatBuyerId = clickedBuyerId;
                    selectedWeapon = weapons.find(w => w.id === ticket.weaponId); // Find weapon details if needed
                    renderPage('chat'); // Navigate to chat page
                });
            });
        }


        async function handleBuyWeapon(weapon) {
            if (!db || !userId) {
                showInfoModal("Firebase belum siap atau pengguna tidak terautentikasi.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userTransactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                const publicTransactionsColRef = collection(db, `artifacts/${appId}/public/data/transactions`); // New public collection

                const q = query(userTransactionsColRef);
                const existingTicketsSnapshot = await getDocs(q);
                let existingTicket = null;

                existingTicketsSnapshot.forEach(doc => {
                    if (doc.data().weaponId === weapon.id && doc.data().status === 'open') {
                        existingTicket = { id: doc.id, ...doc.data() };
                    }
                });

                if (existingTicket) {
                    activeChatTicketId = existingTicket.id;
                    activeChatBuyerId = userId; // For current user's chat
                    showInfoModal(`Anda sudah memiliki tiket transaksi terbuka untuk ${weapon.name}. Melanjutkan chat yang sudah ada.`);
                } else {
                    // Create new ticket in private user collection
                    const newTicketRef = await addDoc(userTransactionsColRef, {
                        weaponId: weapon.id,
                        weaponName: weapon.name,
                        buyerId: userId,
                        status: 'open',
                        createdAt: new Date().toISOString(),
                    });

                    // Create a summary in the public transactions collection for admin view
                    await setDoc(doc(publicTransactionsColRef, newTicketRef.id), {
                        weaponId: weapon.id,
                        weaponName: weapon.name,
                        buyerId: userId,
                        status: 'open',
                        createdAt: new Date().toISOString(),
                        lastMessageAt: new Date().toISOString(), // Track last message time for sorting
                    });

                    activeChatTicketId = newTicketRef.id;
                    activeChatBuyerId = userId; // For current user's chat
                    showInfoModal(`Tiket transaksi baru untuk ${weapon.name} telah dibuat. Silakan mulai chat.`);
                }

                selectedWeapon = weapon;
                renderPage('chat');
            } catch (error) {
                console.error("Error creating/accessing transaction ticket:", error);
                showInfoModal("Gagal memulai transaksi. Silakan coba lagi.");
            }
        }

        async function handleSendMessage() {
            const newMessageInput = document.getElementById('new-message-input');
            const messageText = newMessageInput ? newMessageInput.value.trim() : '';

            if (!db || !userId || !activeChatTicketId || !activeChatBuyerId || messageText === '') { // Ensure buyer ID is available
                showInfoModal("Pesan tidak boleh kosong atau chat belum siap.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Use activeChatBuyerId to send messages to the correct user's transaction
                const messagesColRef = collection(db, `artifacts/${appId}/users/${activeChatBuyerId}/transactions/${activeChatTicketId}/messages`);
                const publicTransactionDocRef = doc(db, `artifacts/${appId}/public/data/transactions`, activeChatTicketId);

                await addDoc(messagesColRef, {
                    senderId: userId,
                    senderName: userId === ADMIN_UID ? 'Admin' : 'Pembeli',
                    message: messageText,
                    timestamp: Date.now(),
                });

                // Update lastMessageAt in public transaction summary
                await updateDoc(publicTransactionDocRef, {
                    lastMessageAt: new Date().toISOString(),
                });

                if (newMessageInput) newMessageInput.value = ''; // Hapus input
            } catch (error) {
                console.error("Error sending message:", error);
                showInfoModal("Gagal mengirim pesan. Silakan coba lagi.");
            }
        }

        async function handleCompleteTransaction() {
            if (!db || !userId || !activeChatTicketId || !activeChatBuyerId || !isAdmin) { // Ensure buyer ID is available
                showInfoModal("Anda tidak memiliki izin untuk menyelesaikan transaksi ini.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Update private user transaction
                const userTransactionDocRef = doc(db, `artifacts/${appId}/users/${activeChatBuyerId}/transactions`, activeChatTicketId);
                await updateDoc(userTransactionDocRef, {
                    status: 'completed',
                    completedAt: new Date().toISOString(),
                });

                // Update public transaction summary
                const publicTransactionDocRef = doc(db, `artifacts/${appId}/public/data/transactions`, activeChatTicketId);
                await updateDoc(publicTransactionDocRef, {
                    status: 'completed',
                    completedAt: new Date().toISOString(),
                });


                showInfoModal("Transaksi berhasil diselesaikan!");
                activeChatTicketId = null;
                activeChatBuyerId = null;
                chatMessages = [];
                renderPage('admin-tickets'); // Kembali ke halaman tiket admin
            } catch (error) {
                console.error("Error completing transaction:", error);
                showInfoModal("Gagal menyelesaikan transaksi. Silakan coba lagi.");
            }
        }

        async function handleUpdateStock(weaponId, newStock) {
            if (!db || !isAdmin) {
                showInfoModal("Anda tidak memiliki izin untuk mengubah stok.");
                return;
            }
            if (newStock < 0) {
                showInfoModal("Stok tidak bisa kurang dari 0.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const weaponDocRef = doc(db, `artifacts/${appId}/public/data/weapons`, weaponId);
                await updateDoc(weaponDocRef, { stock: newStock });
                showInfoModal("Stok berhasil diperbarui!");
            } catch (error) {
                console.error("Error updating stock:", error);
                showInfoModal("Gagal memperbarui stok. Silakan coba lagi.");
            }
        }

        // Fungsi helper untuk memastikan dokumen perantara ada
        async function ensureDocumentExists(path) {
            const docRef = doc(db, path);
            try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    await setDoc(docRef, {}, { merge: true }); // Buat dokumen kosong jika tidak ada
                    console.log(`Document path ${path} created.`);
                }
            } catch (error) {
                console.error(`Error ensuring document path ${path} exists:`, error);
                throw error; // Lempar ulang error agar bisa ditangani di handleAddWeapon
            }
        }

        async function handleAddWeapon() {
            if (!db || !isAdmin) {
                showInfoModal("Anda tidak memiliki izin untuk menambahkan senjata.");
                return;
            }

            const name = newWeaponNameInput.value.trim();
            const description = newWeaponDescriptionInput.value.trim();
            const priceIC = parseInt(newWeaponPriceInput.value);
            const stock = parseInt(newWeaponStockInput.value);

            if (!name || isNaN(priceIC) || isNaN(stock) || priceIC < 0 || stock < 0) {
                showInfoModal("Mohon isi semua field dengan benar (nama, harga, dan stok harus angka positif).");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Pastikan dokumen perantara 'artifacts/{appId}' ada
                await ensureDocumentExists(`artifacts/${appId}`);
                // Koleksi 'public', 'data', dan 'weapons' akan dibuat otomatis oleh addDoc jika belum ada
                const weaponsColRef = collection(db, `artifacts/${appId}/public/data/weapons`);

                await addDoc(weaponsColRef, {
                    name: name,
                    description: description,
                    priceIC: priceIC,
                    stock: stock,
                    createdAt: Date.now()
                });

                showInfoModal("Senjata baru berhasil ditambahkan!");
                addWeaponModal.classList.add('hidden'); // Sembunyikan modal
                // Bersihkan form
                newWeaponNameInput.value = '';
                newWeaponDescriptionInput.value = '';
                newWeaponPriceInput.value = '';
                newWeaponStockInput.value = '';
                renderPage('store'); // Render ulang halaman toko untuk melihat senjata baru
            } catch (error) {
                console.error("Error adding new weapon:", error);
                showInfoModal(`Gagal menambahkan senjata: ${error.message}.`);
            }
        }

        async function handleGenerateWeaponDescription(weaponId, weaponName) {
            if (!db || !isAdmin) {
                showInfoModal("Anda tidak memiliki izin untuk menghasilkan deskripsi.");
                return;
            }

            isGeneratingDescription = true;
            if (document.getElementById('weapons-grid')) {
                renderWeapons();
            }
            showInfoModal("Menghasilkan deskripsi senjata... Mohon tunggu.");

            try {
                const prompt = `Buatkan deskripsi roleplay singkat dan menarik (maksimal 3 kalimat) untuk senjata SAMP Definitive Roleplay bernama ${weaponName}. Fokus pada kegunaan IC (in-character) dan nuansa roleplay.`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas akan menyediakan ini
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;

                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const weaponDocRef = doc(db, `artifacts/${appId}/public/data/weapons`, weaponId);
                    await updateDoc(weaponDocRef, { description: generatedText });

                    showInfoModal(`Deskripsi untuk ${weaponName} berhasil diperbarui!`);
                } else {
                    showInfoModal("Gagal menghasilkan deskripsi. Respon LLM tidak valid.");
                }
            } catch (error) {
                console.error("Error generating weapon description:", error);
                showInfoModal("Terjadi kesalahan saat menghasilkan deskripsi. Silakan coba lagi.");
            } finally {
                isGeneratingDescription = false;
                if (document.getElementById('weapons-grid')) {
                    renderWeapons();
                }
            }
        }

        // Event Listeners untuk modal tambah senjata baru
        performAddWeaponBtn.addEventListener('click', handleAddWeapon);
        closeAddWeaponModalBtn.addEventListener('click', () => {
            addWeaponModal.classList.add('hidden');
            // Bersihkan form
            newWeaponNameInput.value = '';
            newWeaponDescriptionInput.value = '';
            newWeaponPriceInput.value = '';
            newWeaponStockInput.value = '';
        });

        // Inisialisasi Firebase dan render halaman landing saat window dimuat
        window.onload = initializeFirebase;
    </script>
</body>
</html>
